name: Build OpenGLTask

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 设置 CMake
      - name: Set up CMake
        uses: lukka/get-cmake@latest

      # 安装依赖 (Linux 使用 apt，macOS 使用 brew)
      - name: Install dependencies (Linux/macOS)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y libglfw3-dev libglm-dev || true

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install glfw glm || true

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/microsoft/vcpkg --depth 1
          cd vcpkg
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg integrate install
          .\vcpkg install glfw3:x64-windows glm:x64-windows
          echo "CMAKE_TOOLCHAIN_FILE=$PWD\vcpkg\scripts\buildsystems\vcpkg.cmake" >> $GITHUB_ENV
        shell: cmd

      # 4. 配置 CMake（Windows 需要特殊处理）
      - name: Configure CMake
        run: |
          cmake -S . -B build ${{ runner.os == 'Windows' && '-DCMAKE_TOOLCHAIN_FILE=$env:CMAKE_TOOLCHAIN_FILE' || '' }}

      # 编译项目
      - name: Build
        run: cmake --build build --config Release

      # 保存生成的可执行文件
      - name: Upload executables
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-OpenGLTask
          path: |
            build/task*${{ runner.os == 'Windows' && '.exe' || '' }}